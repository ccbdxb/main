<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NFT Mint (Owner)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; background:#0b0c10; color:#eaf5ff; }
    .wrap { max-width: 720px; margin: 40px auto; padding: 24px; background:#11141a; border:1px solid #222936; border-radius:16px; }
    h1 { margin:0 0 8px; }
    .row { display:flex; justify-content:space-between; padding:10px 12px; background:#0e1218; border:1px solid #1d2431; border-radius:10px; margin-top:10px; }
    .stack{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button{ cursor:pointer; padding:10px 14px; border-radius:10px; border:1px solid #2a3344; background:#1f2837; color:#eaf5ff; }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    input[type=text]{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3344; background:#0e1218; color:#eaf5ff; }
    a{ color:#8ab4ff; }
    .muted{ opacity:.8 }
    .error{ color:#ff6b6b }
    .ok{ color:#6bff95 }
  </style>
  <!-- Ethers v6 (UMD global) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js" defer></script>
</head>
<body>
  <div class="wrap">
    <h1>Owner Mint</h1>
    <p class="muted">Network: <span id="network">—</span></p>
    <div class="stack" style="margin:12px 0 20px;">
      <button id="connectBtn">Connect Wallet</button>
      <button id="switchBtn" style="display:none;">Switch to Polygon</button>
      <span id="address" class="muted">Not connected</span>
    </div>

    <div class="row"><span>Supply</span><strong><span id="supply">—</span>/<span id="max">—</span></strong></div>
    <div class="row"><span>Price</span><strong>Free (non-payable)</strong></div>

    <div class="row" style="flex-direction:column; align-items:stretch;">
      <div class="muted" style="margin-bottom:8px;">Recipient address (or comma-separated for batch)</div>
      <input type="text" id="to" placeholder="0x... or addr1,addr2,..." />
      <div class="stack" style="margin-top:10px;">
        <button id="mintMeBtn" disabled>Mint to me</button>
        <button id="mintBtn" disabled>Mint to address(es)</button>
      </div>
    </div>

    <p id="status" class="muted" style="min-height:22px; margin-top:14px;"></p>
    <p id="link" style="min-height:22px;"></p>
  </div>

  <script defer>
    const CONTRACT_ADDRESS = "0xBBF161212103b329b11A41786607B428dD9ED2A3";
    // minimal ABI for your functions
    const ABI = [
      {"type":"function","name":"totalMinted","stateMutability":"view","inputs":[],"outputs":[{"type":"uint256"}]},
      {"type":"function","name":"MAX_SUPPLY","stateMutability":"view","inputs":[],"outputs":[{"type":"uint256"}]},
      {"type":"function","name":"owner","stateMutability":"view","inputs":[],"outputs":[{"type":"address"}]},
      {"type":"function","name":"mint","stateMutability":"nonpayable","inputs":[{"name":"to","type":"address"}],"outputs":[]},
      {"type":"function","name":"mintBatch","stateMutability":"nonpayable","inputs":[{"name":"tos","type":"address[]"}],"outputs":[]},
      {"type":"function","name":"name","stateMutability":"view","inputs":[],"outputs":[{"type":"string"}]},
      {"type":"function","name":"symbol","stateMutability":"view","inputs":[],"outputs":[{"type":"string"}]}
    ];

    const POLYGON_CHAIN_ID_HEX = "0x89"; // 137
    const POLYGON_PARAMS = {
      chainId: POLYGON_CHAIN_ID_HEX,
      chainName: "Polygon",
      nativeCurrency: { name: "MATIC", symbol: "MATIC", decimals: 18 },
      rpcUrls: ["https://polygon-rpc.com","https://rpc.ankr.com/polygon"],
      blockExplorerUrls: ["https://polygonscan.com"]
    };

    const el = id => document.getElementById(id);
    function setStatus(msg, cls="muted"){ const s=el("status"); s.className=cls; s.textContent=msg||""; }

    // Prefer Brave Wallet if multiple injected providers are present
    function getInjectedProvider(){
      const eth = window.ethereum;
      if (!eth) return null;
      if (Array.isArray(eth.providers) && eth.providers.length){
        const brave = eth.providers.find(p=>p.isBraveWallet);
        const metamask = eth.providers.find(p=>p.isMetaMask && !p.isBraveWallet);
        return brave ?? metamask ?? eth.providers[0];
      }
      return eth;
    }

    let provider, signer, contract, ownerAddr, myAddr;

    async function connect(){
      const injected = getInjectedProvider();
      if (!injected){ setStatus("No wallet detected. In Brave, enable Brave Wallet.", "error"); return; }
      try{
        await injected.request({ method:"eth_requestAccounts" });
        provider = new ethers.BrowserProvider(injected);
        signer = await provider.getSigner();
        myAddr = await signer.getAddress();
        el("address").textContent = myAddr.slice(0,6)+"…"+myAddr.slice(-4);

        const net = await provider.getNetwork();
        el("network").textContent = `${net.name} (${Number(net.chainId)})`;

        if (Number(net.chainId) !== 137){
          el("switchBtn").style.display = "inline-block";
          setStatus("Wrong network. Click “Switch to Polygon”.", "error");
          el("mintBtn").disabled = true; el("mintMeBtn").disabled = true;
          return;
        }

        el("switchBtn").style.display = "none";
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        // owner gate
        ownerAddr = await contract.owner();
        const isOwner = ownerAddr.toLowerCase() === myAddr.toLowerCase();
        if (!isOwner){
          setStatus("This contract is owner-only mint. Your wallet is not the owner.", "error");
          el("mintBtn").disabled = true; el("mintMeBtn").disabled = true;
        } else {
          setStatus("");
          el("mintBtn").disabled = false; el("mintMeBtn").disabled = false;
          el("to").value = myAddr; // convenience
        }

        await refreshReads();
      }catch(err){
        console.error(err); setStatus(err?.message || String(err), "error");
      }
    }

    async function switchToPolygon(){
      const injected = getInjectedProvider(); if (!injected) return;
      try{
        await injected.request({ method:"wallet_switchEthereumChain", params:[{ chainId: POLYGON_CHAIN_ID_HEX }] });
      }catch(err){
        if (err && err.code === 4902){
          await injected.request({ method:"wallet_addEthereumChain", params:[POLYGON_PARAMS] });
        } else { throw err; }
      }
      await connect();
    }

    async function refreshReads(){
      if (!contract) return;
      try{
        const [minted, max] = await Promise.all([contract.totalMinted(), contract.MAX_SUPPLY()]);
        el("supply").textContent = String(minted);
        el("max").textContent = String(max);
      }catch(e){ console.warn("read error", e); }
    }

    function parseAddresses(text){
      return text.split(",").map(s=>s.trim()).filter(Boolean);
    }

    async function mintToMe(){
      if (!contract || !myAddr) return;
      try{
        setStatus("Sending tx…");
        const tx = await contract.mint(myAddr);
        el("mintBtn").disabled = true; el("mintMeBtn").disabled = true;
        setStatus("Mining…");
        await tx.wait();
        setStatus("✅ Confirmed", "ok");
        el("link").innerHTML = `<a href="https://polygonscan.com/tx/${tx.hash}" target="_blank">View on Polygonscan</a>`;
        await refreshReads();
      }catch(err){ console.error(err); setStatus("❌ " + (err?.shortMessage || err?.message || String(err)), "error"); }
      finally{ el("mintBtn").disabled = false; el("mintMeBtn").disabled = false; }
    }

    async function mintTo(){
      if (!contract) return;
      const list = parseAddresses(el("to").value);
      if (!list.length) return setStatus("Enter at least one recipient address.", "error");
      try{
        setStatus("Sending tx…");
        let tx;
        if (list.length === 1){
          tx = await contract.mint(list[0]);
        } else {
          tx = await contract.mintBatch(list);
        }
        el("mintBtn").disabled = true; el("mintMeBtn").disabled = true;
        setStatus("Mining…");
        await tx.wait();
        setStatus("✅ Confirmed", "ok");
        el("link").innerHTML = `<a href="https://polygonscan.com/tx/${tx.hash}" target="_blank">View on Polygonscan</a>`;
        await refreshReads();
      }catch(err){ console.error(err); setStatus("❌ " + (err?.shortMessage || err?.message || String(err)), "error"); }
      finally{ el("mintBtn").disabled = false; el("mintMeBtn").disabled = false; }
    }

    // wire buttons
    document.getElementById("connectBtn").addEventListener("click", connect);
    document.getElementById("switchBtn").addEventListener("click", switchToPolygon);
    document.getElementById("mintMeBtn").addEventListener("click", mintToMe);
    document.getElementById("mintBtn").addEventListener("click", mintTo);
  </script>
</body>
</html>
